<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="../../../../lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="../../../../lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="../../../../css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="../../../../images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="../../../../images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="../../../../images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="../../../../images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="NodeJS,Koa," />










<meta name="description" content="一、基本用法1.1 架设 HTTP 服务 1234567&amp;gt; &amp;gt; // demos/01.js&amp;gt; const Koa = require(&amp;apos;koa&amp;apos;);&amp;gt; const app = new Koa();&amp;gt; &amp;gt; app.listen(3000);&amp;gt; 1234&amp;gt; &amp;gt; $ node demos/01.js&amp;gt; &amp;gt;  打开浏览">
<meta name="keywords" content="NodeJS,Koa">
<meta property="og:type" content="article">
<meta property="og:title" content="Node框架学习(2)--Koa">
<meta property="og:url" content="http://www.needqq.com/2019/01/11/Node_Koa/index.html">
<meta property="og:site_name" content="Majun">
<meta property="og:description" content="一、基本用法1.1 架设 HTTP 服务 1234567&amp;gt; &amp;gt; // demos/01.js&amp;gt; const Koa = require(&amp;apos;koa&amp;apos;);&amp;gt; const app = new Koa();&amp;gt; &amp;gt; app.listen(3000);&amp;gt; 1234&amp;gt; &amp;gt; $ node demos/01.js&amp;gt; &amp;gt;  打开浏览">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-01-11T07:14:20.915Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Node框架学习(2)--Koa">
<meta name="twitter:description" content="一、基本用法1.1 架设 HTTP 服务 1234567&amp;gt; &amp;gt; // demos/01.js&amp;gt; const Koa = require(&amp;apos;koa&amp;apos;);&amp;gt; const app = new Koa();&amp;gt; &amp;gt; app.listen(3000);&amp;gt; 1234&amp;gt; &amp;gt; $ node demos/01.js&amp;gt; &amp;gt;  打开浏览">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.needqq.com/2019/01/11/Node_Koa/"/>





  <title>Node框架学习(2)--Koa | Majun</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Majun</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.needqq.com">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Majun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="../../../../images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Majun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Node框架学习(2)--Koa</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-11T15:14:20+08:00">
                2019-01-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="../../../../categories/NodeJS/" itemprop="url" rel="index">
                    <span itemprop="name">NodeJS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="一、基本用法"><a href="#一、基本用法" class="headerlink" title="一、基本用法"></a>一、基本用法</h2><h3 id="1-1-架设-HTTP-服务"><a href="#1-1-架设-HTTP-服务" class="headerlink" title="1.1 架设 HTTP 服务"></a>1.1 架设 HTTP 服务</h3><blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; // demos/01.js</span><br><span class="line">&gt; const Koa = require(&apos;koa&apos;);</span><br><span class="line">&gt; const app = new Koa();</span><br><span class="line">&gt; </span><br><span class="line">&gt; app.listen(3000);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ node demos/01.js</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>打开浏览器，访问 <a href="http://127.0.0.1:3000" target="_blank" rel="external">http://127.0.0.1:3000</a> 。你会看到页面显示”Not Found”，表示没有发现任何内容。这是因为我们并没有告诉 Koa 应该显示什么内容。</p>
<h3 id="1-2-Context-对象"><a href="#1-2-Context-对象" class="headerlink" title="1.2 Context 对象"></a>1.2 Context 对象</h3><p>Koa 提供一个 Context 对象，表示一次对话的上下文（包括 HTTP 请求和 HTTP 回复）。通过加工这个对象，就可以控制返回给用户的内容。</p>
<p><code>Context.response.body</code>属性就是发送给用户的内容。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; // demos/02.js</span><br><span class="line">&gt; const Koa = require(&apos;koa&apos;);</span><br><span class="line">&gt; const app = new Koa();</span><br><span class="line">&gt; </span><br><span class="line">&gt; const main = ctx =&gt; &#123;</span><br><span class="line">&gt;   ctx.response.body = &apos;Hello World&apos;;</span><br><span class="line">&gt; &#125;;</span><br><span class="line">&gt; </span><br><span class="line">&gt; app.use(main);</span><br><span class="line">&gt; app.listen(3000);</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>上面代码中，<code>main</code>函数用来设置<code>ctx.response.body</code>。然后，使用<code>app.use</code>方法加载<code>main</code>函数。</p>
<p><code>ctx.response</code>代表 HTTP Response。同样地，<code>ctx.request</code>代表 HTTP Request。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ node demos/02.js</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>访问 <a href="http://127.0.0.1:3000" target="_blank" rel="external">http://127.0.0.1:3000</a> ，现在就可以看到”Hello World”了。</p>
<h3 id="1-3-HTTP-Response-的类型"><a href="#1-3-HTTP-Response-的类型" class="headerlink" title="1.3 HTTP Response 的类型"></a>1.3 HTTP Response 的类型</h3><p>Koa 默认的返回类型是<code>text/plain</code>，如果想返回其他类型的内容，可以先用<code>ctx.request.accepts</code>判断一下，客户端希望接受什么数据（根据 HTTP Request 的<code>Accept</code>字段），然后使用<code>ctx.response.type</code>指定返回类型。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; // demos/03.js</span><br><span class="line">&gt; const main = ctx =&gt; &#123;</span><br><span class="line">&gt;   if (ctx.request.accepts(&apos;xml&apos;)) &#123;</span><br><span class="line">&gt;     ctx.response.type = &apos;xml&apos;;</span><br><span class="line">&gt;     ctx.response.body = &apos;&lt;data&gt;Hello World&lt;/data&gt;&apos;;</span><br><span class="line">&gt;   &#125; else if (ctx.request.accepts(&apos;json&apos;)) &#123;</span><br><span class="line">&gt;     ctx.response.type = &apos;json&apos;;</span><br><span class="line">&gt;     ctx.response.body = &#123; data: &apos;Hello World&apos; &#125;;</span><br><span class="line">&gt;   &#125; else if (ctx.request.accepts(&apos;html&apos;)) &#123;</span><br><span class="line">&gt;     ctx.response.type = &apos;html&apos;;</span><br><span class="line">&gt;     ctx.response.body = &apos;&lt;p&gt;Hello World&lt;/p&gt;&apos;;</span><br><span class="line">&gt;   &#125; else &#123;</span><br><span class="line">&gt;     ctx.response.type = &apos;text&apos;;</span><br><span class="line">&gt;     ctx.response.body = &apos;Hello World&apos;;</span><br><span class="line">&gt;   &#125;</span><br><span class="line">&gt; &#125;;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ node demos/03.js</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>访问 <a href="http://127.0.0.1:3000" target="_blank" rel="external">http://127.0.0.1:3000</a> ，现在看到的就是一个 XML 文档了。</p>
<p>[图片上传失败…(image-14a658-1512521964504)]</p>
<h3 id="1-4-网页模板"><a href="#1-4-网页模板" class="headerlink" title="1.4 网页模板"></a>1.4 网页模板</h3><p>实际开发中，返回给用户的网页往往都写成模板文件。我们可以让 Koa 先读取模板文件，然后将这个模板返回给用户。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; // demos/04.js</span><br><span class="line">&gt; const fs = require(&apos;fs&apos;);</span><br><span class="line">&gt; </span><br><span class="line">&gt; const main = ctx =&gt; &#123;</span><br><span class="line">&gt;   ctx.response.type = &apos;html&apos;;</span><br><span class="line">&gt;   ctx.response.body = fs.createReadStream(&apos;./demos/template.html&apos;);</span><br><span class="line">&gt; &#125;;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ node demos/04.js</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>访问 <a href="http://127.0.0.1:3000" target="_blank" rel="external">http://127.0.0.1:3000</a> ，看到的就是<a href="https://github.com/ruanyf/koa-demos/blob/master/demos/template.html" target="_blank" rel="external">模板文件</a>的内容了。</p>
<h2 id="二、路由"><a href="#二、路由" class="headerlink" title="二、路由"></a>二、路由</h2><h3 id="2-1-原生路由"><a href="#2-1-原生路由" class="headerlink" title="2.1 原生路由"></a>2.1 原生路由</h3><p>网站一般都有多个页面。通过<code>ctx.request.path</code>可以获取用户请求的路径，由此实现简单的路由。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; // demos/05.js</span><br><span class="line">&gt; const main = ctx =&gt; &#123;</span><br><span class="line">&gt;   if (ctx.request.path !== &apos;/&apos;) &#123;</span><br><span class="line">&gt;     ctx.response.type = &apos;html&apos;;</span><br><span class="line">&gt;     ctx.response.body = &apos;&lt;a href=&quot;/&quot;&gt;Index Page&lt;/a&gt;&apos;;</span><br><span class="line">&gt;   &#125; else &#123;</span><br><span class="line">&gt;     ctx.response.body = &apos;Hello World&apos;;</span><br><span class="line">&gt;   &#125;</span><br><span class="line">&gt; &#125;;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ node demos/05.js</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>访问 <a href="http://127.0.0.1:3000/about" target="_blank" rel="external">http://127.0.0.1:3000/about</a> ，可以看到一个链接，点击后就跳到首页。</p>
<h3 id="2-2-koa-route-模块"><a href="#2-2-koa-route-模块" class="headerlink" title="2.2 koa-route 模块"></a>2.2 koa-route 模块</h3><p>原生路由用起来不太方便，我们可以使用封装好的<a href="https://www.npmjs.com/package/koa-route" target="_blank" rel="external"><code>koa-route</code></a>模块。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; // demos/06.js</span><br><span class="line">&gt; const route = require(&apos;koa-route&apos;);</span><br><span class="line">&gt; </span><br><span class="line">&gt; const about = ctx =&gt; &#123;</span><br><span class="line">&gt;   ctx.response.type = &apos;html&apos;;</span><br><span class="line">&gt;   ctx.response.body = &apos;&lt;a href=&quot;/&quot;&gt;Index Page&lt;/a&gt;&apos;;</span><br><span class="line">&gt; &#125;;</span><br><span class="line">&gt; </span><br><span class="line">&gt; const main = ctx =&gt; &#123;</span><br><span class="line">&gt;   ctx.response.body = &apos;Hello World&apos;;</span><br><span class="line">&gt; &#125;;</span><br><span class="line">&gt; </span><br><span class="line">&gt; app.use(route.get(&apos;/&apos;, main));</span><br><span class="line">&gt; app.use(route.get(&apos;/about&apos;, about));</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>上面代码中，根路径<code>/</code>的处理函数是<code>main</code>，<code>/about</code>路径的处理函数是<code>about</code>。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ node demos/06.js</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>访问 <a href="http://127.0.0.1:3000/about" target="_blank" rel="external">http://127.0.0.1:3000/about</a> </p>
<h3 id="2-3-静态资源"><a href="#2-3-静态资源" class="headerlink" title="2.3 静态资源"></a>2.3 静态资源</h3><p>如果网站提供静态资源（图片、字体、样式表、脚本……），为它们一个个写路由就很麻烦，也没必要。<a href="https://www.npmjs.com/package/koa-static" target="_blank" rel="external"><code>koa-static</code></a>模块封装了这部分的请求。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; // demos/12.js</span><br><span class="line">&gt; const path = require(&apos;path&apos;);</span><br><span class="line">&gt; const serve = require(&apos;koa-static&apos;);</span><br><span class="line">&gt; </span><br><span class="line">&gt; const main = serve(path.join(__dirname));</span><br><span class="line">&gt; app.use(main);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ node demos/12.js</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>访问 <a href="http://127.0.0.1:3000/12.js，在浏览器里就可以看到这个脚本的内容。" target="_blank" rel="external">http://127.0.0.1:3000/12.js，在浏览器里就可以看到这个脚本的内容。</a></p>
<h3 id="2-4-重定向"><a href="#2-4-重定向" class="headerlink" title="2.4 重定向"></a>2.4 重定向</h3><p>有些场合，服务器需要重定向（redirect）访问请求。比如，用户登陆以后，将他重定向到登陆前的页面。<code>ctx.response.redirect()</code>方法可以发出一个302跳转，将用户导向另一个路由。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; // demos/13.js</span><br><span class="line">&gt; const redirect = ctx =&gt; &#123;</span><br><span class="line">&gt;   ctx.response.redirect(&apos;/&apos;);</span><br><span class="line">&gt;   ctx.response.body = &apos;&lt;a href=&quot;/&quot;&gt;Index Page&lt;/a&gt;&apos;;</span><br><span class="line">&gt; &#125;;</span><br><span class="line">&gt; </span><br><span class="line">&gt; app.use(route.get(&apos;/redirect&apos;, redirect));</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ node demos/13.js</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>访问 <a href="http://127.0.0.1:3000/redirect" target="_blank" rel="external">http://127.0.0.1:3000/redirect</a> ，浏览器会将用户导向根路由。</p>
<h2 id="三、中间件"><a href="#三、中间件" class="headerlink" title="三、中间件"></a>三、中间件</h2><h3 id="3-1-Logger-功能"><a href="#3-1-Logger-功能" class="headerlink" title="3.1 Logger 功能"></a>3.1 Logger 功能</h3><p>Koa 的最大特色，也是最重要的一个设计，就是中间件（middleware）。为了理解中间件，我们先看一下 Logger （打印日志）功能的实现。</p>
<p>最简单的写法就是在<code>main</code>函数里面增加一行。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; // demos/07.js</span><br><span class="line">&gt; const main = ctx =&gt; &#123;</span><br><span class="line">&gt;   console.log(`$&#123;Date.now()&#125; $&#123;ctx.request.method&#125; $&#123;ctx.request.url&#125;`);</span><br><span class="line">&gt;   ctx.response.body = &apos;Hello World&apos;;</span><br><span class="line">&gt; &#125;;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ node demos/07.js</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>访问 <a href="http://127.0.0.1:3000" target="_blank" rel="external">http://127.0.0.1:3000</a> ，命令行就会输出日志。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; 1502144902843 GET /</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="3-2-中间件的概念"><a href="#3-2-中间件的概念" class="headerlink" title="3.2 中间件的概念"></a>3.2 中间件的概念</h3><p>上一个例子里面的 Logger 功能，可以拆分成一个独立函数。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; // demos/08.js</span><br><span class="line">&gt; const logger = (ctx, next) =&gt; &#123;</span><br><span class="line">&gt;   console.log(`$&#123;Date.now()&#125; $&#123;ctx.request.method&#125; $&#123;ctx.request.url&#125;`);</span><br><span class="line">&gt;   next();</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; app.use(logger);</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>像上面代码中的<code>logger</code>函数就叫做”中间件”（middleware），因为它处在 HTTP Request 和 HTTP Response 中间，用来实现某种中间功能。<code>app.use()</code>用来加载中间件。</p>
<p>基本上，Koa 所有的功能都是通过中间件实现的，前面例子里面的<code>main</code>也是中间件。每个中间件默认接受两个参数，第一个参数是 Context 对象，第二个参数是<code>next</code>函数。只要调用<code>next</code>函数，就可以把执行权转交给下一个中间件。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ node demos/08.js</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="3-3-中间件栈"><a href="#3-3-中间件栈" class="headerlink" title="3.3 中间件栈"></a>3.3 中间件栈</h3><p>多个中间件会形成一个栈结构（middle stack），以”先进后出”（first-in-last-out）的顺序执行。</p>
<blockquote>
<ol>
<li>最外层的中间件首先执行。</li>
<li>调用<code>next</code>函数，把执行权交给下一个中间件。</li>
<li>…</li>
<li>最内层的中间件最后执行。</li>
<li>执行结束后，把执行权交回上一层的中间件。</li>
<li>…</li>
<li>最外层的中间件收回执行权之后，执行<code>next</code>函数后面的代码。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; // demos/09.js</span><br><span class="line">&gt; const one = (ctx, next) =&gt; &#123;</span><br><span class="line">&gt;   console.log(&apos;&gt;&gt; one&apos;);</span><br><span class="line">&gt;   next();</span><br><span class="line">&gt;   console.log(&apos;&lt;&lt; one&apos;);</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; </span><br><span class="line">&gt; const two = (ctx, next) =&gt; &#123;</span><br><span class="line">&gt;   console.log(&apos;&gt;&gt; two&apos;);</span><br><span class="line">&gt;   next(); </span><br><span class="line">&gt;   console.log(&apos;&lt;&lt; two&apos;);</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; </span><br><span class="line">&gt; const three = (ctx, next) =&gt; &#123;</span><br><span class="line">&gt;   console.log(&apos;&gt;&gt; three&apos;);</span><br><span class="line">&gt;   next();</span><br><span class="line">&gt;   console.log(&apos;&lt;&lt; three&apos;);</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; </span><br><span class="line">&gt; app.use(one);</span><br><span class="line">&gt; app.use(two);</span><br><span class="line">&gt; app.use(three);</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ node demos/09.js</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>访问 <a href="http://127.0.0.1:3000" target="_blank" rel="external">http://127.0.0.1:3000</a> ，命令行窗口会有如下输出。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; &gt;&gt; one</span><br><span class="line">&gt; &gt;&gt; two</span><br><span class="line">&gt; &gt;&gt; three</span><br><span class="line">&gt; &lt;&lt; three</span><br><span class="line">&gt; &lt;&lt; two</span><br><span class="line">&gt; &lt;&lt; one</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>如果中间件内部没有调用<code>next</code>函数，那么执行权就不会传递下去。作为练习，你可以将<code>two</code>函数里面<code>next()</code>这一行注释掉再执行，看看会有什么结果。</p>
<h3 id="3-4-异步中间件"><a href="#3-4-异步中间件" class="headerlink" title="3.4 异步中间件"></a>3.4 异步中间件</h3><p>迄今为止，所有例子的中间件都是同步的，不包含异步操作。如果有异步操作（比如读取数据库），中间件就必须写成 <a href="http://es6.ruanyifeng.com/#docs/async" target="_blank" rel="external">async 函数</a>。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; // demos/10.js</span><br><span class="line">&gt; const fs = require(&apos;fs.promised&apos;);</span><br><span class="line">&gt; const Koa = require(&apos;koa&apos;);</span><br><span class="line">&gt; const app = new Koa();</span><br><span class="line">&gt; </span><br><span class="line">&gt; const main = async function (ctx, next) &#123;</span><br><span class="line">&gt;   ctx.response.type = &apos;html&apos;;</span><br><span class="line">&gt;   ctx.response.body = await fs.readFile(&apos;./demos/template.html&apos;, &apos;utf8&apos;);</span><br><span class="line">&gt; &#125;;</span><br><span class="line">&gt; </span><br><span class="line">&gt; app.use(main);</span><br><span class="line">&gt; app.listen(3000);</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>上面代码中，<code>fs.readFile</code>是一个异步操作，必须写成<code>await fs.readFile()</code>，然后中间件必须写成 async 函数。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ node demos/10.js</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>访问 <a href="http://127.0.0.1:3000" target="_blank" rel="external">http://127.0.0.1:3000</a> ，就可以看到模板文件的内容。</p>
<h3 id="3-5-中间件的合成"><a href="#3-5-中间件的合成" class="headerlink" title="3.5 中间件的合成"></a>3.5 中间件的合成</h3><p><a href="https://www.npmjs.com/package/koa-compose" target="_blank" rel="external"><code>koa-compose</code></a>模块可以将多个中间件合成为一个。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; // demos/11.js</span><br><span class="line">&gt; const compose = require(&apos;koa-compose&apos;);</span><br><span class="line">&gt; </span><br><span class="line">&gt; const logger = (ctx, next) =&gt; &#123;</span><br><span class="line">&gt;   console.log(`$&#123;Date.now()&#125; $&#123;ctx.request.method&#125; $&#123;ctx.request.url&#125;`);</span><br><span class="line">&gt;   next();</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; </span><br><span class="line">&gt; const main = ctx =&gt; &#123;</span><br><span class="line">&gt;   ctx.response.body = &apos;Hello World&apos;;</span><br><span class="line">&gt; &#125;;</span><br><span class="line">&gt; </span><br><span class="line">&gt; const middlewares = compose([logger, main]);</span><br><span class="line">&gt; app.use(middlewares);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ node demos/11.js</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>访问 <a href="http://127.0.0.1:3000" target="_blank" rel="external">http://127.0.0.1:3000</a> ，就可以在命令行窗口看到日志信息。</p>
<h2 id="四、错误处理"><a href="#四、错误处理" class="headerlink" title="四、错误处理"></a>四、错误处理</h2><h3 id="4-1-500-错误"><a href="#4-1-500-错误" class="headerlink" title="4.1 500 错误"></a>4.1 500 错误</h3><p>如果代码运行过程中发生错误，我们需要把错误信息返回给用户。HTTP 协定约定这时要返回500状态码。Koa 提供了<code>ctx.throw()</code>方法，用来抛出错误，<code>ctx.throw(500)</code>就是抛出500错误。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; // demos/14.js</span><br><span class="line">&gt; const main = ctx =&gt; &#123;</span><br><span class="line">&gt;   ctx.throw(500);</span><br><span class="line">&gt; &#125;;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ node demos/14.js</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>访问 <a href="http://127.0.0.1:3000，你会看到一个500错误页&quot;Internal" target="_blank" rel="external">http://127.0.0.1:3000，你会看到一个500错误页&quot;Internal</a> Server Error”。</p>
<p>4.2 404错误</p>
<p>如果将<code>ctx.response.status</code>设置成404，就相当于<code>ctx.throw(404)</code>，返回404错误。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; // demos/15.js</span><br><span class="line">&gt; const main = ctx =&gt; &#123;</span><br><span class="line">&gt;   ctx.response.status = 404;</span><br><span class="line">&gt;   ctx.response.body = &apos;Page Not Found&apos;;</span><br><span class="line">&gt; &#125;;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ node demos/15.js</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>访问 <a href="http://127.0.0.1:3000" target="_blank" rel="external">http://127.0.0.1:3000</a> ，你就看到一个404页面”Page Not Found”。</p>
<h3 id="4-3-处理错误的中间件"><a href="#4-3-处理错误的中间件" class="headerlink" title="4.3 处理错误的中间件"></a>4.3 处理错误的中间件</h3><p>为了方便处理错误，最好使用<code>try...catch</code>将其捕获。但是，为每个中间件都写<code>try...catch</code>太麻烦，我们可以让最外层的中间件，负责所有中间件的错误处理。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; // demos/16.js</span><br><span class="line">&gt; const handler = async (ctx, next) =&gt; &#123;</span><br><span class="line">&gt;   try &#123;</span><br><span class="line">&gt;     await next();</span><br><span class="line">&gt;   &#125; catch (err) &#123;</span><br><span class="line">&gt;     ctx.response.status = err.statusCode || err.status || 500;</span><br><span class="line">&gt;     ctx.response.body = &#123;</span><br><span class="line">&gt;       message: err.message</span><br><span class="line">&gt;     &#125;;</span><br><span class="line">&gt;   &#125;</span><br><span class="line">&gt; &#125;;</span><br><span class="line">&gt; </span><br><span class="line">&gt; const main = ctx =&gt; &#123;</span><br><span class="line">&gt;   ctx.throw(500);</span><br><span class="line">&gt; &#125;;</span><br><span class="line">&gt; </span><br><span class="line">&gt; app.use(handler);</span><br><span class="line">&gt; app.use(main);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ node demos/16.js</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>访问 <a href="http://127.0.0.1:3000" target="_blank" rel="external">http://127.0.0.1:3000</a> ，你会看到一个500页，里面有报错提示 <code>{&quot;message&quot;:&quot;Internal Server Error&quot;}</code>。</p>
<h3 id="4-4-error-事件的监听"><a href="#4-4-error-事件的监听" class="headerlink" title="4.4 error 事件的监听"></a>4.4 error 事件的监听</h3><p>运行过程中一旦出错，Koa 会触发一个<code>error</code>事件。监听这个事件，也可以处理错误。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; // demos/17.js</span><br><span class="line">&gt; const main = ctx =&gt; &#123;</span><br><span class="line">&gt;   ctx.throw(500);</span><br><span class="line">&gt; &#125;;</span><br><span class="line">&gt; </span><br><span class="line">&gt; app.on(&apos;error&apos;, (err, ctx) =&gt;</span><br><span class="line">&gt;   console.error(&apos;server error&apos;, err);</span><br><span class="line">&gt; );</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ node demos/17.js</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>访问 <a href="http://127.0.0.1:3000" target="_blank" rel="external">http://127.0.0.1:3000</a> ，你会在命令行窗口看到”server error xxx”。</p>
<h3 id="4-5-释放-error-事件"><a href="#4-5-释放-error-事件" class="headerlink" title="4.5 释放 error 事件"></a>4.5 释放 error 事件</h3><p>需要注意的是，如果错误被<code>try...catch</code>捕获，就不会触发<code>error</code>事件。这时，必须调用<code>ctx.app.emit()</code>，手动释放<code>error</code>事件，才能让监听函数生效。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; // demos/18.js`</span><br><span class="line">&gt; const handler = async (ctx, next) =&gt; &#123;</span><br><span class="line">&gt;   try &#123;</span><br><span class="line">&gt;     await next();</span><br><span class="line">&gt;   &#125; catch (err) &#123;</span><br><span class="line">&gt;     ctx.response.status = err.statusCode || err.status || 500;</span><br><span class="line">&gt;     ctx.response.type = &apos;html&apos;;</span><br><span class="line">&gt;     ctx.response.body = &apos;&lt;p&gt;Something wrong, please contact administrator.&lt;/p&gt;&apos;;</span><br><span class="line">&gt;     ctx.app.emit(&apos;error&apos;, err, ctx);</span><br><span class="line">&gt;   &#125;</span><br><span class="line">&gt; &#125;;</span><br><span class="line">&gt; </span><br><span class="line">&gt; const main = ctx =&gt; &#123;</span><br><span class="line">&gt;   ctx.throw(500);</span><br><span class="line">&gt; &#125;;</span><br><span class="line">&gt; </span><br><span class="line">&gt; app.on(&apos;error&apos;, function(err) &#123;</span><br><span class="line">&gt;   console.log(&apos;logging error &apos;, err.message);</span><br><span class="line">&gt;   console.log(err);</span><br><span class="line">&gt; &#125;);</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>上面代码中，<code>main</code>函数抛出错误，被<code>handler</code>函数捕获。<code>catch</code>代码块里面使用<code>ctx.app.emit()</code>手动释放<code>error</code>事件，才能让监听函数监听到。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ node demos/18.js</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>访问 <a href="http://127.0.0.1:3000" target="_blank" rel="external">http://127.0.0.1:3000</a> ，你会在命令行窗口看到<code>logging error</code>。</p>
<h2 id="五、Web-App-的功能"><a href="#五、Web-App-的功能" class="headerlink" title="五、Web App 的功能"></a>五、Web App 的功能</h2><h3 id="5-1-Cookies"><a href="#5-1-Cookies" class="headerlink" title="5.1 Cookies"></a>5.1 Cookies</h3><p><code>ctx.cookies</code>用来读写 Cookie。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; // demos/19.js</span><br><span class="line">&gt; const main = function(ctx) &#123;</span><br><span class="line">&gt;   const n = Number(ctx.cookies.get(&apos;view&apos;) || 0) + 1;</span><br><span class="line">&gt;   ctx.cookies.set(&apos;view&apos;, n);</span><br><span class="line">&gt;   ctx.response.body = n + &apos; views&apos;;</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ node demos/19.js</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>访问 <a href="http://127.0.0.1:3000" target="_blank" rel="external">http://127.0.0.1:3000</a> ，你会看到<code>1 views</code>。刷新一次页面，就变成了<code>2 views</code>。再刷新，每次都会计数增加1。</p>
<h3 id="5-2-表单"><a href="#5-2-表单" class="headerlink" title="5.2 表单"></a>5.2 表单</h3><p>Web 应用离不开处理表单。本质上，表单就是 POST 方法发送到服务器的键值对。<a href="https://www.npmjs.com/package/koa-body" target="_blank" rel="external"><code>koa-body</code></a>模块可以用来从 POST 请求的数据体里面提取键值对。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; // demos/20.js</span><br><span class="line">&gt; const koaBody = require(&apos;koa-body&apos;);</span><br><span class="line">&gt; </span><br><span class="line">&gt; const main = async function(ctx) &#123;</span><br><span class="line">&gt;   const body = ctx.request.body;</span><br><span class="line">&gt;   if (!body.name) ctx.throw(400, &apos;.name required&apos;);</span><br><span class="line">&gt;   ctx.body = &#123; name: body.name &#125;;</span><br><span class="line">&gt; &#125;;</span><br><span class="line">&gt; </span><br><span class="line">&gt; app.use(koaBody());</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ node demos/20.js</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>打开另一个命令行窗口，运行下面的命令。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ curl -X POST --data &quot;name=Jack&quot; 127.0.0.1:3000</span><br><span class="line">&gt; &#123;&quot;name&quot;:&quot;Jack&quot;&#125;</span><br><span class="line">&gt; </span><br><span class="line">&gt; $ curl -X POST --data &quot;name&quot; 127.0.0.1:3000</span><br><span class="line">&gt; name required</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>上面代码使用 POST 方法向服务器发送一个键值对，会被正确解析。如果发送的数据不正确，就会收到错误提示。</p>
<h3 id="5-3-文件上传"><a href="#5-3-文件上传" class="headerlink" title="5.3 文件上传"></a>5.3 文件上传</h3><p><a href="https://www.npmjs.com/package/koa-body" target="_blank" rel="external"><code>koa-body</code></a>模块还可以用来处理文件上传。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; // demos/21.js</span><br><span class="line">&gt; const os = require(&apos;os&apos;);</span><br><span class="line">&gt; const path = require(&apos;path&apos;);</span><br><span class="line">&gt; const koaBody = require(&apos;koa-body&apos;);</span><br><span class="line">&gt; </span><br><span class="line">&gt; const main = async function(ctx) &#123;</span><br><span class="line">&gt;   const tmpdir = os.tmpdir();</span><br><span class="line">&gt;   const filePaths = [];</span><br><span class="line">&gt;   const files = ctx.request.body.files || &#123;&#125;;</span><br><span class="line">&gt; </span><br><span class="line">&gt;   for (let key in files) &#123;</span><br><span class="line">&gt;     const file = files[key];</span><br><span class="line">&gt;     const filePath = path.join(tmpdir, file.name);</span><br><span class="line">&gt;     const reader = fs.createReadStream(file.path);</span><br><span class="line">&gt;     const writer = fs.createWriteStream(filePath);</span><br><span class="line">&gt;     reader.pipe(writer);</span><br><span class="line">&gt;     filePaths.push(filePath);</span><br><span class="line">&gt;   &#125;</span><br><span class="line">&gt; </span><br><span class="line">&gt;   ctx.body = filePaths;</span><br><span class="line">&gt; &#125;;</span><br><span class="line">&gt; </span><br><span class="line">&gt; app.use(koaBody(&#123; multipart: true &#125;));</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ node demos/21.js</span><br><span class="line">&gt; </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>打开另一个命令行窗口，运行下面的命令，上传一个文件。注意，<code>/path/to/file</code>要更换为真实的文件路径。</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; </span><br><span class="line">&gt; $ curl --form upload=@/path/to/file http://127.0.0.1:3000</span><br><span class="line">&gt; [&quot;/tmp/file&quot;]</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<p>参考自 <a href="http://www.ruanyifeng.com/blog/2017/08/koa.html" target="_blank" rel="external">http://www.ruanyifeng.com/blog/2017/08/koa.html</a><br><a href="https://github.com/ruanyf/koa-demos" target="_blank" rel="external">示例库</a><br><a href="https://github.com/ruanyf/koa-demos/archive/master.zip" target="_blank" rel="external">zip 文件</a><br><a href="https://github.com/ruanyf/koa-demos/tree/master/demos" target="_blank" rel="external">demos</a></p>
</blockquote>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="../../../../tags/NodeJS/" rel="tag"># NodeJS</a>
          
            <a href="../../../../tags/Koa/" rel="tag"># Koa</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="../Node_MongDB_MySQL/" rel="next" title="Node连接MongDB,MySQL">
                <i class="fa fa-chevron-left"></i> Node连接MongDB,MySQL
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="../Node_Jade00/" rel="prev" title="Node模板引擎学习(1)--Jade">
                Node模板引擎学习(1)--Jade <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Majun</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="../../../../archives">
              
                  <span class="site-state-item-count">88</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="../../../../categories/index.html">
                  <span class="site-state-item-count">29</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="../../../../tags/index.html">
                  <span class="site-state-item-count">52</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、基本用法"><span class="nav-number">1.</span> <span class="nav-text">一、基本用法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-架设-HTTP-服务"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 架设 HTTP 服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-Context-对象"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 Context 对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-HTTP-Response-的类型"><span class="nav-number">1.3.</span> <span class="nav-text">1.3 HTTP Response 的类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-网页模板"><span class="nav-number">1.4.</span> <span class="nav-text">1.4 网页模板</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、路由"><span class="nav-number">2.</span> <span class="nav-text">二、路由</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-原生路由"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 原生路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-koa-route-模块"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 koa-route 模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-静态资源"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 静态资源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-重定向"><span class="nav-number">2.4.</span> <span class="nav-text">2.4 重定向</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、中间件"><span class="nav-number">3.</span> <span class="nav-text">三、中间件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-Logger-功能"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 Logger 功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-中间件的概念"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 中间件的概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-中间件栈"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 中间件栈</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-异步中间件"><span class="nav-number">3.4.</span> <span class="nav-text">3.4 异步中间件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-中间件的合成"><span class="nav-number">3.5.</span> <span class="nav-text">3.5 中间件的合成</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、错误处理"><span class="nav-number">4.</span> <span class="nav-text">四、错误处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-500-错误"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 500 错误</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-处理错误的中间件"><span class="nav-number">4.2.</span> <span class="nav-text">4.3 处理错误的中间件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-error-事件的监听"><span class="nav-number">4.3.</span> <span class="nav-text">4.4 error 事件的监听</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-释放-error-事件"><span class="nav-number">4.4.</span> <span class="nav-text">4.5 释放 error 事件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五、Web-App-的功能"><span class="nav-number">5.</span> <span class="nav-text">五、Web App 的功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-Cookies"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 Cookies</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-表单"><span class="nav-number">5.2.</span> <span class="nav-text">5.2 表单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-文件上传"><span class="nav-number">5.3.</span> <span class="nav-text">5.3 文件上传</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Majun</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  







  
  
    <script type="text/javascript" src="../../../../lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="../../../../lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="../../../../lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="../../../../lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../../../lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="../../../../lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="../../../../lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="../../../../lib/three/canvas_lines.min.js"></script>
  


  


  <script type="text/javascript" src="../../../../js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="../../../../js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="../../../../js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="../../../../js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="../../../../js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  









<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//unpkg.com/valine/dist/Valine.min.js"></script>



  





  

  

  

  
  

  

  

  

</body>
</html>
